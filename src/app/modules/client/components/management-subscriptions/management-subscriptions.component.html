<p-card styleClass="card-header">
  <div class="card-header-content">
    <div class="p-card-content">
      <span class="p-input-icon-left">
        <app-icon-search
          style="color: #496382"
          class="search-icon"
          (click)="onSearch()"
        ></app-icon-search>
        <input
          type="text"
          style="width: 200px"
          pInputText
          [(ngModel)]="searchTerm"
          [ngModelOptions]="{ standalone: true }"
          (keyup.enter)="onSearch()"
        />
        <span
          class="pi pi-info-circle ml-2"
          style="color: var(--cor-primaria)"
          pTooltip="Search by Status, Recurrence or Monitor Street."
        ></span>
      </span>
    </div>
  </div>
</p-card>

<p-table
  [value]="subscriptions"
  [loading]="loading"
  styleClass="p-datatable-sm"
  [paginator]="true"
  [rows]="currentFilters?.size || 10"
  [totalRecords]="ensureValidNumber(totalRecords)"
  [rowsPerPageOptions]="[5, 10, 25, 50]"
  [showCurrentPageReport]="true"
  responsiveLayout="scroll"
  [lazy]="true"
  currentPageReportTemplate="Showing {first} to {last} of {totalRecords} subscriptions"
  paginatorDropdownAppendTo="body"
  (onPage)="onPageChange($event)"
  (onSort)="onSort($event)"
  [sortField]="currentFilters.sortBy"
  [sortOrder]="currentFilters.sortDir === 'asc' ? 1 : -1"
>
  <ng-template pTemplate="header">
    <tr>
      <th scope="col">Locations</th>
      <th scope="col" pSortableColumn="status">
        Status <p-sortIcon field="status"></p-sortIcon>
      </th>
      <th scope="col" pSortableColumn="recurrence">
        Recurrence <p-sortIcon field="recurrence"></p-sortIcon>
      </th>
      <th scope="col">Amount</th>
      <th scope="col" pSortableColumn="startedAt">
        Started At <p-sortIcon field="startedAt"></p-sortIcon>
      </th>
      <th scope="col" pSortableColumn="endsAt">
        Ends At <p-sortIcon field="endsAt"></p-sortIcon>
      </th>
      <th scope="col">Days Left</th>
      <th scope="col">Actions</th>
    </tr>
  </ng-template>

  <ng-template pTemplate="body" let-subscription>
    <tr>
      <td>{{ getSubscriptionLocations(subscription) }}</td>
      <td>
        <p-badge
          [value]="
            subscription.status
              ? subscription.status.charAt(0).toUpperCase() +
                subscription.status.slice(1).toLowerCase()
              : ''
          "
          [severity]="getSubscriptionStatusSeverity(subscription.status)"
        ></p-badge>
      </td>
      <td>
        {{ getRecurrenceLabel(subscription.recurrence) }}
      </td>
      <td>{{ subscription.amount | currency }}</td>
      <td>{{ subscription.startedAt | date: "shortDate" }}</td>
      <td>
        {{
          subscription.endsAt ? (subscription.endsAt | date: "shortDate") : "-"
        }}
      </td>
      <td>
        <p-badge
          *ngIf="
            subscription.daysLeft !== null &&
            subscription.daysLeft !== undefined
          "
          [value]="getDaysLeftDisplay(subscription.daysLeft)"
          [severity]="getDaysLeftSeverity(subscription.daysLeft)"
        ></p-badge>
        <span
          *ngIf="
            subscription.daysLeft === null ||
            subscription.daysLeft === undefined
          "
        >
          -
        </span>
      </td>

      <td>
        <div class="action-buttons">
          <button
            *ngIf="subscription.ableToUpgrade"
            pButton
            pRipple
            icon="pi pi-star-fill"
            class="p-button-rounded p-button-text upgrade-button"
            (click)="onUpgradeMode(subscription)"
            pTooltip="Upgrade Subscription"
            tooltipPosition="top"
          ></button>

          <button
            pButton
            pRipple
            icon="pi pi-trash"
            class="p-button-rounded p-button-danger p-button-text"
            (click)="cancelSubscription(subscription)"
            [disabled]="subscription.status !== 'ACTIVE'"
            [pTooltip]="
              subscription.status === 'ACTIVE' ? 'Cancel Subscription' : null
            "
            tooltipPosition="top"
          ></button>
        </div>
      </td>
    </tr>
  </ng-template>
  <ng-template pTemplate="emptymessage">
    <tr>
      <td colspan="4" class="text-center">No subscriptions found.</td>
    </tr>
  </ng-template>
</p-table>

<!-- Upgrade Dialog -->
<div class="dialog-upgrade-subscription-container">
  <p-dialog
    [(visible)]="showUpgradeDialog"
    [modal]="true"
    [closable]="true"
    [draggable]="false"
    [resizable]="false"
    styleClass="upgrade-dialog"
    header="Upgrade Subscription"
    [style]="{ width: '50%', maxWidth: '600px', minWidth: '340px' }"
    (onHide)="hideUpgradeDialog()"
  >
    <div class="upgrade-dialog-content">
      <div
        class="current-subscription-info"
        *ngIf="selectedSubscriptionForUpgrade"
      >
        <h4>Current Subscription</h4>
        <p>
          <strong>Recurrence:</strong>
          {{ getRecurrenceLabel(selectedSubscriptionForUpgrade.recurrence) }}
        </p>
      </div>

      <div class="upgrade-options" *ngIf="availableUpgradeOptions.length > 0">
        <h4>Select New Recurrence</h4>
        <p-dropdown
          [options]="availableUpgradeOptions"
          [(ngModel)]="selectedUpgradeRecurrence"
          placeholder="Select upgrade option"
          optionLabel="label"
          optionValue="value"
          [style]="{ width: '100%' }"
          appendTo="body"
          [overlayOptions]="{ appendTo: 'body' }"
        ></p-dropdown>
      </div>

      <div class="upgrade-info" *ngIf="selectedUpgradeRecurrence">
        <div class="info-message">
          <i class="pi pi-info-circle"></i>
          <span
            >You will be redirected to complete the payment for your
            subscription upgrade.</span
          >
        </div>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <div class="dialog-footer w-full">
        <button
          id="btnSecundario"
          pButton
          label="Cancel"
          severity="secondary"
          (click)="hideUpgradeDialog()"
          [disabled]="loading"
        ></button>
        <button
          pButton
          label="Confirm Upgrade"
          severity="primary"
          (click)="confirmUpgrade()"
          [disabled]="!selectedUpgradeRecurrence || loading"
          [loading]="loading"
        ></button>
      </div>
    </ng-template>
  </p-dialog>
</div>
