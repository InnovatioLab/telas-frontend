<p-card styleClass="card-header">
  <div class="card-header-content">
    <div class="p-card-content">
      <span class="p-input-icon-left">
        <app-icon-search
          style="color: #496382"
          class="search-icon"
          (click)="onSearch()"
        ></app-icon-search>
        <input
          type="text"
          style="width: 200px"
          pInputText
          placeholder="Search clients..."
          [(ngModel)]="searchTerm"
          [ngModelOptions]="{ standalone: true }"
          (keyup.enter)="onSearch()"
        />
        <span
          class="pi pi-info-circle ml-2"
          style="color: var(--cor-primaria)"
          pTooltip="Search by BusinessName, Phone, Email, Industry or Role"
        ></span>
      </span>
    </div>
  </div>
</p-card>

<input
  #fileInput
  type="file"
  [accept]="acceptedFileTypes"
  style="display: none"
  (change)="onFileInputChange($event)"
/>

<p-table
  [value]="clients"
  [loading]="loading"
  styleClass="p-datatable-sm"
  [paginator]="true"
  [rows]="currentFilters.size || 10"
  [totalRecords]="totalRecords"
  [rowsPerPageOptions]="[5, 10, 25, 50]"
  [showCurrentPageReport]="true"
  responsiveLayout="scroll"
  [lazy]="true"
  currentPageReportTemplate="Showing {first} to {last} of {totalRecords} clients"
  paginatorDropdownAppendTo="body"
  (onPage)="onPageChange($event)"
  (onSort)="onSort($event)"
  [sortField]="currentFilters.sortBy || 'name'"
  [sortOrder]="currentFilters.sortDir === 'asc' ? 1 : -1"
>
  <ng-template pTemplate="header">
    <tr>
      <th scope="col" pSortableColumn="businessName">
        Name <p-sortIcon field="businessName"></p-sortIcon>
      </th>
      <th scope="col" pSortableColumn="email">
        Email <p-sortIcon field="email"></p-sortIcon>
      </th>
      <th scope="col" pSortableColumn="status">
        Status <p-sortIcon field="status"></p-sortIcon>
      </th>
      <th scope="col" pSortableColumn="role">
        Role <p-sortIcon field="role"></p-sortIcon>
      </th>
      <th scope="col">Ads</th>
      <th scope="col" pSortableColumn="createdAt">
        Created At <p-sortIcon field="createdAt"></p-sortIcon>
      </th>
      <th scope="col">Actions</th>
    </tr>
  </ng-template>

  <ng-template pTemplate="body" let-client>
    <tr>
      <td class="text-center">
        {{ client.businessName ?? "N/A" }}
      </td>
      <td class="text-center">
        {{ client.contact?.email }}
      </td>

      <td class="text-center">
        {{
          client.status
            ? client.status.charAt(0).toUpperCase() +
              client.status.slice(1).toLowerCase()
            : ""
        }}
      </td>
      <td class="text-center">
        <p-badge
          [value]="getPartnerStatusLabel(client.role || '')"
          [severity]="getPartnerStatusSeverity(client.role || '')"
        >
        </p-badge>
      </td>
      <td class="text-center">
        <span *ngIf="client.role === 'PARTNER'">
          {{ client.ads?.length || 0 }} / {{ PARTNER_MAX_ADS }}
        </span>
        <span *ngIf="client.role !== 'PARTNER'">-</span>
      </td>
      <td class="text-center">{{ client.createdAt | date: "MM/dd/yyyy" }}</td>
      <td class="text-center">
        <div class="action-buttons">
          <button
            *ngIf="client.role !== 'PARTNER'"
            pButton
            pRipple
            icon="pi pi-user-plus"
            class="p-button-rounded p-button-success p-button-text"
            (click)="makePartner(client)"
            pTooltip="Make Partner"
          ></button>
          <button
            *ngIf="client.role === 'PARTNER'"
            pButton
            pRipple
            icon="pi pi-upload"
            class="p-button-rounded p-button-success p-button-text"
            (click)="uploadAdForPartner(client)"
            pTooltip="Upload Ad"
          ></button>
          <button
            pButton
            pRipple
            icon="pi pi-pencil"
            class="p-button-rounded p-button-info p-button-text"
            (click)="editClient(client)"
            pTooltip="Edit Client"
          ></button>
        </div>
      </td>
    </tr>
  </ng-template>

  <ng-template pTemplate="emptymessage">
    <tr>
      <td colspan="9" class="text-center">No clients found.</td>
    </tr>
  </ng-template>
</p-table>

<!-- Upload Ad Dialog -->
<p-dialog
  header="Upload Ad"
  [(visible)]="showUploadAdDialog"
  [modal]="true"
  [closable]="true"
  [dismissableMask]="true"
  [style]="{ width: '90%', maxWidth: '700px' }"
  [draggable]="false"
  [resizable]="false"
>
  <div class="upload-content">
    <!-- File Preview -->
    <div
      *ngIf="filePreview && selectedFile"
      class="file-preview flex flex-column align-items-center gap-3"
    >
      <h4 class="align-self-start">Selected File Preview:</h4>
      
      <!-- PDF Preview -->
      <div *ngIf="isPdfAttachment(selectedFile.name)" class="pdf-preview-container">
        <pdf-viewer
          [src]="filePreview"
          [render-text]="true"
          [original-size]="false"
          [show-all]="false"
          [fit-to-page]="true"
          [zoom]="0.8"
          [zoom-scale]="'page-width'"
          [stick-to-page]="true"
          style="display: block; width: 100%; min-height: 400px; max-height: 500px;"
        ></pdf-viewer>
        <div class="pdf-preview-info">
          <p class="pdf-preview-name">{{ selectedFile.name }}</p>
          <p class="pdf-preview-size">{{ formatFileSize(selectedFile.size) }}</p>
        </div>
      </div>

      <!-- Image Preview -->
      <img
        *ngIf="!isPdfAttachment(selectedFile.name)"
        [src]="filePreview"
        alt="File Preview"
        class="preview-image"
      />
    </div>
  </div>

  <ng-template pTemplate="footer">
    <div class="upload-dialog-footer w-full flex justify-content-center gap-3">
      <button
        pButton
        id="btnSecundario"
        label="Cancel"
        (click)="closeUploadAdDialog()"
      ></button>
      <button
        pButton
        label="Upload"
        (click)="uploadAd()"
        [disabled]="!selectedFile || loadingUpload"
        [loading]="loadingUpload"
      ></button>
    </div>
  </ng-template>
</p-dialog>
