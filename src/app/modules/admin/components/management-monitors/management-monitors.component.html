<div class="content">
  <p-card styleClass="card-header">
    <div class="card-header-content">
      <div class="p-card-content">
        <div class="w-full flex align-items-center gap-2">
          <span class="p-input-icon-left">
            <app-icon-search
              class="search-icon search-icon-color"
              (click)="onSearch()"
            ></app-icon-search>
            <input
              type="text"
              class="search-input-width"
              pInputText
              placeholder="Search Screens..."
              [(ngModel)]="searchTerm"
              [ngModelOptions]="{ standalone: true }"
              (keyup.enter)="onSearch()"
            />
          </span>
          <span
            class="pi pi-info-circle info-icon"
            pTooltip="Search by address, status, type or size"
            tooltipPosition="top"
          ></span>
        </div>

        <div
          class="create-monitor-container w-full flex justify-content-center align-items-center"
        >
          <button
            pButton
            class="btn-create-monitor"
            label="Create Screen"
            icon="pi pi-plus"
            (click)="openCreateMonitorModal()"
            onKeyDown="openCreateMonitorModal()"
          ></button>
        </div>
      </div>
    </div>
  </p-card>

  <p-table
    [value]="monitors"
    [loading]="loading"
    styleClass="p-datatable-sm"
    [paginator]="true"
    [rows]="currentFilters?.size || 10"
    [totalRecords]="ensureValidNumber(totalRecords)"
    [rowsPerPageOptions]="[5, 10, 25, 50]"
    [showCurrentPageReport]="true"
    responsiveLayout="scroll"
    [lazy]="true"
    currentPageReportTemplate="Showing {first} to {last} of {totalRecords} screens"
    paginatorDropdownAppendTo="body"
    (onPage)="onPageChange($event)"
    (onSort)="onSort($event)"
    [sortField]="currentFilters.sortBy"
    [sortOrder]="currentFilters.sortDir === 'asc' ? 1 : -1"
  >
    <ng-template pTemplate="header">
      <tr>
        <th scope="col" pSortableColumn="active">
          Status <p-sortIcon field="active"></p-sortIcon>
        </th>
        <th scope="col" pSortableColumn="address">
          Address <p-sortIcon field="address"></p-sortIcon>
        </th>
        <th scope="col">Actions</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-monitor>
      <tr>
        <td>
          <p-badge
            [value]="monitor.active ? 'Active' : 'Inactive'"
            [severity]="monitor.active ? 'success' : 'danger'"
          ></p-badge>
        </td>
        <td>{{ getMonitorAddress(monitor) }}</td>
        <td>
          <div class="action-buttons">
            <button
              [disabled]="!shouldShowManageAdsButton(monitor)"
              pButton
              pRipple
              class="p-button-rounded p-button-info p-button-text btn-manage-ads"
              [routerLink]="['/admin/screens', monitor.id, 'manage-ads']"
              pTooltip="Manage Ads"
              tooltipPosition="top"
            >
              <app-icon-tv-display
                class="custom-icon btn-manage-ads-icon"
              ></app-icon-tv-display>
            </button>
            <button
              pButton
              pRipple
              class="p-button-rounded p-button-success p-button-text btn-edit-screen"
              (click)="onSelectMonitor(monitor)"
              pTooltip="Edit Screen"
              tooltipPosition="top"
            >
              <app-icon-etiqueta
                class="custom-icon btn-edit-screen-icon"
              ></app-icon-etiqueta>
            </button>
            <button
              pButton
              pRipple
              class="p-button-rounded p-button-text btn-upload-ads"
              (click)="openUploadAdsModal(monitor)"
              pTooltip="Upload ads"
              tooltipPosition="top"
            >
              <app-icon-upload
                class="custom-icon btn-upload-ads-icon"
              ></app-icon-upload>
            </button>
            <button
              pButton
              pRipple
              class="p-button-rounded p-button-danger p-button-text btn-delete-screen"
              (click)="deleteMonitor(monitor)"
              [disabled]="!monitor.canBeDeleted"
              pTooltip="{{
                !monitor.canBeDeleted
                  ? 'This Screen has an active subscription and cannot be deleted.'
                  : 'Delete Screen'
              }}"
              tooltipPosition="top"
            >
              <app-icon-trash
                class="custom-icon btn-delete-screen-icon"
              ></app-icon-trash>
            </button>
          </div>
        </td>
      </tr>
    </ng-template>
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="4" class="text-center">No Screens found.</td>
      </tr>
    </ng-template>
  </p-table>

  <!-- Modal de criação de monitor -->
  <p-dialog
    [(visible)]="createMonitorModalVisible"
    [modal]="true"
    [style]="{ width: '50vw', maxWidth: '800px' }"
    [breakpoints]="{ '1199px': '75vw', '575px': '90vw' }"
    [draggable]="false"
    [resizable]="false"
    [closeOnEscape]="true"
    [dismissableMask]="true"
    [showHeader]="false"
    [contentStyle]="{
      padding: '0',
      'border-radius': '8px',
      overflow: 'hidden',
    }"
  >
    <app-create-monitor-modal
      #createMonitorModal
      (close)="onCreateMonitorModalClose()"
      (monitorCreated)="onMonitorCreated($event)"
    >
    </app-create-monitor-modal>
  </p-dialog>

  <!-- Modal de edição de monitor -->
  <p-dialog
    [(visible)]="editMonitorModalVisible"
    [modal]="true"
    [style]="{ width: '50vw', maxWidth: '800px' }"
    [breakpoints]="{ '1199px': '75vw', '575px': '90vw' }"
    [draggable]="false"
    [resizable]="false"
    [closeOnEscape]="true"
    [dismissableMask]="true"
    [showHeader]="false"
    [closable]="true"
    [contentStyle]="{ padding: '0', 'border-radius': '8px', overflow: 'none' }"
  >
    <app-edit-monitor-modal
      #editMonitorModal
      [monitor]="selectedMonitorForEdit"
      (close)="onEditMonitorModalClose()"
      (monitorUpdated)="onMonitorUpdated($event)"
    >
    </app-edit-monitor-modal>
  </p-dialog>

  <!-- Modal de gerenciamento de Ads removido em favor da nova tela de gerenciamento -->

  <!-- Modal de confirmação de delete -->
  <p-dialog
    header="Confirm Deletion"
    [(visible)]="deleteConfirmModalVisible"
    [style]="{ width: '50vw', maxWidth: '500px' }"
    [breakpoints]="{ '1199px': '75vw', '575px': '90vw' }"
    [modal]="true"
    [closeOnEscape]="true"
    [dismissableMask]="true"
    [draggable]="false"
  >
    <div class="delete-confirmation" *ngIf="selectedMonitorForDelete">
      <div class="confirmation-content">
        <span
          class="pi pi-exclamation-triangle"
          class="delete-warning-icon"
        ></span>
        <h4>Are you sure you want to delete this Screen?</h4>
        <p>
          <strong>Address:</strong>
          {{ getMonitorAddress(selectedMonitorForDelete) }}
        </p>

        <p class="warning-text">This action cannot be undone.</p>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <div
        class="actions w-full flex justify-content-between align-items-center"
      >
        <button
          pButton
          pRipple
          label="Cancel"
          id="btnSecundario"
          icon="pi pi-times"
          class="p-button-text"
          (click)="closeDeleteConfirmModal()"
          [disabled]="loading"
        ></button>
        <button
          pButton
          pRipple
          label="Delete"
          icon="pi pi-trash"
          class="p-button-danger btn-danger"
          (click)="confirmDelete()"
          [loading]="loading"
          [disabled]="loading"
        ></button>
      </div>
    </ng-template>
  </p-dialog>

  <!-- Modal de upload de ads -->
  <p-dialog
    header="Upload Ad"
    [(visible)]="showCreateAdModal"
    [modal]="true"
    [closable]="true"
    [dismissableMask]="true"
    [style]="{ width: '95vw', maxWidth: '600px' }"
    [draggable]="false"
    [resizable]="false"
  >
    <form (ngSubmit)="createAdvertisement()" #adForm="ngForm">
      <input
        #fileInput
        id="adFile"
        type="file"
        (change)="onFileSelected($event)"
        [accept]="acceptedFileTypes"
        class="hidden-input"
        required
      />

      <div class="upload-content">
        <!-- File Preview -->
        <div
          *ngIf="uploadAdPreview && selectedFile"
          class="file-preview flex flex-column align-items-center gap-3"
        >
          <h4 class="align-self-start">Selected File Preview:</h4>
          
          <!-- PDF Preview -->
          <div *ngIf="isPdfFile(selectedFile.name)" class="pdf-preview-container">
            <pdf-viewer
              [src]="uploadAdPreview"
              [render-text]="true"
              [original-size]="false"
              [show-all]="false"
              [fit-to-page]="true"
              [zoom]="0.8"
              [zoom-scale]="'page-width'"
              [stick-to-page]="true"
              style="display: block; width: 100%; min-height: 400px; max-height: 500px;"
            ></pdf-viewer>
            <div class="pdf-preview-info">
              <p class="pdf-preview-name">{{ selectedFile.name }}</p>
              <p class="pdf-preview-size">{{ formatFileSize(selectedFile.size) }}</p>
            </div>
          </div>

          <!-- Image Preview -->
          <img
            *ngIf="!isPdfFile(selectedFile.name)"
            [src]="uploadAdPreview"
            [alt]="selectedFile.name"
            class="preview-image"
          />
        </div>
      </div>

      <div
        class="p-dialog-footer flex align-items-center justify-content-between"
        style="margin-top: 2rem"
      >
        <button
          pButton
          type="button"
          id="btnSecundario"
          label="Cancel"
          class="p-button-text"
          (click)="showCreateAdModal = false"
        ></button>
        <button
          pButton
          type="submit"
          label="Upload"
          class="p-button-text"
          [disabled]="loadingCreateAd || !adForm.form.valid"
        ></button>
      </div>
    </form>
  </p-dialog>
</div>
