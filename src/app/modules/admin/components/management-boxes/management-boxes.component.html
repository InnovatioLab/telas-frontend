<p-card styleClass="card-header">
  <div class="card-header-content">
    <div class="p-card-content">
      <button
        pButton
        label="Create Box"
        icon="pi pi-plus"
        (click)="openCreateBoxModal()"
        onKeyDown="openCreateBoxModal()"
      ></button>
    </div>
  </div>
</p-card>

<p-table
  [value]="boxes"
  [loading]="loading"
  styleClass="p-datatable-sm"
  [paginator]="true"
  [rows]="currentFilters?.size || 10"
  [totalRecords]="totalRecords"
  [rowsPerPageOptions]="[5, 10, 25, 50]"
  [showCurrentPageReport]="true"
  responsiveLayout="scroll"
  [lazy]="true"
  currentPageReportTemplate="Showing {first} to {last} of {totalRecords} boxes"
  paginatorDropdownAppendTo="body"
  (onPage)="onPageChange($event)"
  (onSort)="onSort($event)"
  [sortField]="currentFilters?.sortBy || 'active'"
  [sortOrder]="currentFilters?.sortDir === 'asc' ? 1 : -1"
>
  <ng-template pTemplate="header">
    <tr>
      <th scope="col" pSortableColumn="ip">
        IP Address <p-sortIcon field="ip"></p-sortIcon>
      </th>
      <th scope="col">MAC Address</th>
      <th scope="col" pSortableColumn="active">
        Status <p-sortIcon field="active"></p-sortIcon>
      </th>
      <th scope="col">Monitors</th>
      <th scope="col">Actions</th>
    </tr>
  </ng-template>

  <ng-template pTemplate="body" let-box>
    <tr>
      <td class="text-center">{{ box.ip }}</td>
      <td class="text-center">{{ box.macAddress || "N/A" }}</td>
      <td class="text-center">
        <p-badge
          [value]="box.active ? 'Active' : 'Inactive'"
          [severity]="box.active ? 'success' : 'danger'"
        ></p-badge>
      </td>
      <td class="text-center">
        <div class="flex align-items-center gap-2 justify-content-center">
          <app-icon-tv-display class="monitor-icon"></app-icon-tv-display>
          <span class="monitor-count"
            >{{ box.monitorCount || 0 }} screen(s)</span
          >
        </div>
      </td>
      <td class="text-center">
        <div class="action-buttons">
          <button
            pButton
            pRipple
            icon="pi pi-pencil"
            class="p-button-rounded p-button-success p-button-text edit-btn icon-button"
            (click)="onSelectBox(box)"
            pTooltip="Edit Box"
          ></button>
        </div>
      </td>
    </tr>
  </ng-template>
  <ng-template pTemplate="emptymessage">
    <tr>
      <td colspan="5" class="text-center">No boxes found.</td>
    </tr>
  </ng-template>
</p-table>

<!-- Modal de criação de box -->
<p-dialog
  header="Create New Box"
  [(visible)]="createBoxModalVisible"
  [modal]="true"
  [style]="{ width: '70vw', maxWidth: '600px' }"
  [breakpoints]="{ '1199px': '75vw', '575px': '90vw' }"
  [draggable]="false"
  [resizable]="false"
  [closeOnEscape]="true"
  [dismissableMask]="true"
>
  <div class="box-form">
    <div class="form-group">
      <label for="boxAddress" class="required">IP Address</label>
      <p-select
        id="boxAddress"
        [options]="availableBoxAddresses"
        [(ngModel)]="selectedBoxAddress"
        [ngModelOptions]="{ standalone: true }"
        optionLabel="ip"
        placeholder="Select an IP address"
        class="w-full"
        [loading]="loadingBoxAddresses"
        [disabled]="loadingBoxAddresses"
        (onChange)="onBoxAddressChange($event.value)"
        [overlayOptions]="{ appendTo: 'body' }"
      >
        <ng-template #empty>
          <p class="font-semibold">No IP address found.</p>
        </ng-template>
      </p-select>

      <small class="help-text" *ngIf="loadingBoxAddresses"
        >Loading IP addresses...</small
      >
      <small
        class="help-text error-text"
        *ngIf="!loadingBoxAddresses && availableBoxAddresses.length === 0"
        >Please create box addresses first.</small
      >
    </div>

    <div class="form-group">
      <label for="monitors">Select Monitors</label>
      <p-multiSelect
        id="monitors"
        [options]="availableMonitors"
        [(ngModel)]="selectedMonitorGroupsCreate"
        [ngModelOptions]="{ standalone: true }"
        optionLabel="fullAddress"
        optionValue="monitorIds"
        placeholder="Select monitors"
        class="w-full"
        [loading]="loadingMonitors"
        [disabled]="loadingMonitors"
        [overlayOptions]="{ appendTo: 'body' }"
        [filter]="true"
        [virtualScroll]="true"
        [maxSelectedLabels]="2"
        [displaySelectedLabel]="true"
        filterPlaceHolder="Type address to search..."
        emptyFilterMessage="No monitors found."
        emptyMessage="No monitors found."
        [resetFilterOnHide]="true"
        filterBy="fullAddress"
        [autofocusFilter]="true"
      >
        <ng-template let-option pTemplate="item">
          <div
            class="flex justify-content-start align-items-center w-full sm:gap-1 gap-2"
          >
            <div class="flex align-items-center sm:gap-1 gap-2">
              <span
                class="text-xs md:text-sm lg:text-sm font-bold primary-dark-color"
                >{{ option.monitorIds?.length || 0 }}</span
              >
              <app-icon-tv-display class="monitor-icon"></app-icon-tv-display>
            </div>
            <span class="text-xs md:text-sm lg:text-sm">{{
              option.fullAddress
            }}</span>
          </div>
        </ng-template>
      </p-multiSelect>

      <small class="help-text" *ngIf="loadingMonitors"
        >Loading monitors...</small
      >
      <small
        class="help-text error-text"
        *ngIf="!loadingMonitors && availableMonitors.length === 0"
        >Please create monitors first.</small
      >
    </div>
  </div>

  <ng-template pTemplate="footer">
    <div class="w-full flex gap-3 justify-content-between align-items-center">
      <button
        pButton
        pRipple
        id="btnSecundario"
        label="Cancel"
        icon="pi pi-times"
        class="p-button-text"
        (click)="onCreateBoxModalClose()"
      ></button>
      <button
        pButton
        pRipple
        label="Create"
        icon="pi pi-check"
        (click)="onCreateBox()"
      ></button>
    </div>
  </ng-template>
</p-dialog>

<!-- Modal de edição de box -->
<p-dialog
  header="Edit Box"
  [(visible)]="editBoxModalVisible"
  [modal]="true"
  [style]="{ width: '70vw', maxWidth: '600px' }"
  [breakpoints]="{ '1199px': '75vw', '575px': '90vw' }"
  [draggable]="false"
  [resizable]="false"
  [closeOnEscape]="true"
  [dismissableMask]="true"
>
  <div class="box-form" *ngIf="selectedBoxForEdit">
    <div class="form-group">
      <label for="editBoxAddress" class="required">IP Address</label>
      <p-select
        id="editBoxAddress"
        [options]="availableBoxAddresses"
        [(ngModel)]="selectedBoxAddress"
        [ngModelOptions]="{ standalone: true }"
        optionLabel="ip"
        placeholder="Select an IP address"
        class="w-full"
        [loading]="loadingBoxAddresses"
        [disabled]="loadingBoxAddresses"
        (onChange)="onEditBoxAddressChange($event.value)"
      >
      </p-select>
      <ng-template pTemplate="empty">
        <span>No IP address found.</span>
      </ng-template>
      <small class="help-text" *ngIf="loadingBoxAddresses"
        >Loading IP addresses...</small
      >
      <small
        class="help-text error-text"
        *ngIf="!loadingBoxAddresses && availableBoxAddresses.length === 0"
        >No IP addresses available. Please create box addresses first.</small
      >
    </div>

    <div class="form-group">
      <label for="editMonitors">Select Monitors</label>
      <p-multiSelect
        id="editMonitors"
        [options]="availableMonitors"
        [(ngModel)]="selectedMonitorGroupsEdit"
        [ngModelOptions]="{ standalone: true }"
        optionLabel="fullAddress"
        optionValue="monitorIds"
        placeholder="Select monitors"
        class="w-full"
        [loading]="loadingMonitors"
        [disabled]="loadingMonitors"
        [overlayOptions]="{ appendTo: 'body' }"
        appendTo="body"
        [filter]="true"
        [virtualScroll]="true"
        [maxSelectedLabels]="2"
        [displaySelectedLabel]="true"
        filterPlaceHolder="Type address to search..."
        emptyFilterMessage="No monitors found."
        emptyMessage="No monitors found."
        [resetFilterOnHide]="true"
        filterBy="fullAddress"
        [autofocusFilter]="true"
      >
        <ng-template let-option pTemplate="item">
          <div
            class="flex justify-content-start align-items-center w-full sm:gap-1 gap-2"
          >
            <div class="flex align-items-center sm:gap-1 gap-2">
              <span
                class="text-xs md:text-sm lg:text-sm font-bold primary-dark-color"
                >{{ option.monitorIds?.length || 0 }}</span
              >
              <app-icon-tv-display class="monitor-icon"></app-icon-tv-display>
            </div>
            <span class="text-xs md:text-sm lg:text-sm">{{
              option.fullAddress
            }}</span>
          </div>
        </ng-template>
      </p-multiSelect>
      <small class="help-text" *ngIf="loadingMonitors"
        >Loading monitors...</small
      >
      <small
        class="help-text error-text"
        *ngIf="!loadingMonitors && availableMonitors.length === 0"
        >No monitors available. Please create monitors first.</small
      >
    </div>
  </div>

  <ng-template pTemplate="footer">
    <div class="w-full flex gap-3 justify-content-between align-items-center">
      <button
        pButton
        pRipple
        label="Cancel"
        id="btnSecundario"
        icon="pi pi-times"
        class="p-button-text"
        (click)="onEditBoxModalClose()"
      ></button>
      <button
        pButton
        pRipple
        label="Update"
        icon="pi pi-check"
        (click)="onEditBox()"
      ></button>
    </div>
  </ng-template>
</p-dialog>
