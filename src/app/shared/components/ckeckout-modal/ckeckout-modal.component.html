<div class="checkout-modal-container">
  <div class="checkout-header">
    <h2 class="modal-title">{{ getStepTitle() }}</h2>
    <div class="checkout-steps">
      <span
        class="step"
        [ngClass]="{
          active: isStepActive(steps.REVIEW),
          completed: isStepCompleted(steps.REVIEW),
        }"
      >
        <i *ngIf="isStepCompleted(steps.REVIEW)" class="pi pi-check-circle"></i>
        <span>Items</span> </span
      >S
      <i class="pi pi-angle-right"></i>
      <span
        class="step"
        [ngClass]="{
          active: isStepActive(steps.PAYMENT),
          completed: isStepCompleted(steps.PAYMENT),
        }"
      >
        <i
          *ngIf="isStepCompleted(steps.PAYMENT)"
          class="pi pi-check-circle"
        ></i>
        <span>Payment</span>
      </span>
    </div>
  </div>

  <div class="checkout-content">
    <div *ngIf="currentStep === steps.REVIEW">
      <div class="customer-info" *ngIf="clienteLogado">
        <h3>Customer Data</h3>
        <div class="info-row">
          <span class="info-label">Name:</span>
          <span class="info-value">{{
            clienteLogado.name || "Not provided"
          }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Email:</span>
          <span class="info-value">{{
            clienteLogado.email || "Not provided"
          }}</span>
        </div>
      </div>

      <div class="order-items">
        <h3>Selected Monitors</h3>
        <p-table
          [value]="itensCarrinho"
          [responsive]="true"
          styleClass="p-datatable-sm"
        >
          <ng-template pTemplate="header">
            <tr>
              <th>Location</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-item>
            <tr>
              <td>
                <div class="item-name">{{ item.title || "Map Location" }}</div>
                <div class="item-coords" *ngIf="item.latitude">
                  Coordinates: {{ item.latitude.toFixed(6) }},
                  {{ item.longitude.toFixed(6) }}
                </div>
              </td>
            </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="4" class="text-center">No ads selected</td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </div>

    <!-- Step 2: Payment -->
    <div *ngIf="currentStep === steps.PAYMENT">
      <div class="payment-info">
        <h3>Payment Information</h3>
        <p class="payment-description">
          Please complete the payment to proceed with your ad campaign. Your
          payment is secured by our payment processor.
        </p>

        <div class="payment-summary">
          <h3>Summary</h3>
          <div class="summary-row">
            <span>Subtotal:</span>
            <span>{{ valorTotalPedido | formatarPreco }}</span>
          </div>
          <div class="summary-row total">
            <span>Total:</span>
            <span>{{ valorTotalPedido | formatarPreco }}</span>
          </div>
        </div>

        <div class="payment-component">
          <ui-payment
            [amount]="valorTotalPedido"
            [processando]="paymentProcessing"
            (paymentSuccess)="handlePaymentSuccess($event)"
            (paymentError)="handlePaymentError($event)"
          >
          </ui-payment>

          <div *ngIf="paymentError" class="payment-error mt-3">
            <div class="p-message p-message-error">
              <div class="p-message-wrapper">
                <span class="p-message-icon pi pi-times-circle"></span>
                <div class="p-message-text">{{ paymentError }}</div>
              </div>
            </div>
          </div>

          <div class="payment-status" *ngIf="paymentCompleted">
            <div class="p-message p-message-success">
              <div class="p-message-wrapper">
                <span class="p-message-icon pi pi-check-circle"></span>
                <div class="p-message-text">
                  Payment processed successfully!
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="confirming" class="processing-overlay">
      <div class="spinner-container">
        <i class="pi pi-spin pi-spinner" style="font-size: 2rem"></i>
      </div>
      <p>Finalizing your order...</p>
    </div>
  </div>

  <div class="checkout-footer" *ngIf="currentStep !== steps.PAYMENT">
    <button
      *ngIf="currentStep !== steps.REVIEW"
      pButton
      type="button"
      [label]="'Previous'"
      icon="pi pi-arrow-left"
      class="p-button-outlined"
      id="btnSecondary"
      (click)="previousStep()"
      [disabled]="paymentProcessing || confirming"
    ></button>

    <!-- <button
      pButton
      type="button"
      [label]="getButtonLabel()"
      icon="pi pi-arrow-right"
      [iconPos]="'right'"
      [class]="'p-button-primary'
      "
      (click)="
        !paymentCompleted
          ? processarPagamento()
          : nextStep()
      "
      [disabled]="
        (currentStep === steps.PAYMENT &&
          !paymentCompleted &&
          paymentProcessing) ||
        confirming
      "
    ></button> -->
    <button
      pButton
      type="button"
      [label]="getButtonLabel()"
      icon="pi pi-arrow-right"
      [iconPos]="'right'"
      [class]="'p-button-primary'"
      (click)="!paymentCompleted ? processarPagamento() : nextStep()"
    ></button>
  </div>
</div>
